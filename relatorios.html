<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Relatórios — Serra Nobre V3.0</title>
  <style>
    body{ margin:0; font-family:System-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background:#f1f5f9; color:#0f172a }
    header{ display:flex; align-items:center; gap:12px; padding:12px 16px; background:#0f766e; color:#fff }
    header h1{ margin:0; font-size:18px; }
    main{ max-width:1200px; margin:16px auto; padding:0 12px 40px }
    .card{ background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:14px }
    .filters{ display:grid; grid-template-columns:repeat(6,minmax(0,1fr)); gap:10px }
    label{ font-size:12px; color:#334155; display:block; margin-bottom:4px }
    input, select{ width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:8px; outline:0 }
    .actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
    .btn{ border:1px solid #0ea5a6; background:#0ea5a6; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer }
    .btn.ghost{ background:#fff; color:#0ea5a6 }
    .table-wrap{ margin-top:14px; overflow:auto; border-radius:10px; border:1px solid #e2e8f0 }
    table{ width:100%; min-width:960px; border-collapse:collapse; background:#fff }
    thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid #e2e8f0; text-align:left; font-size:12px; color:#334155; padding:10px }
    tbody td{ border-bottom:1px solid #f1f5f9; padding:10px; font-size:14px }
    .login { max-width:380px; margin:50px auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08) }
    .muted{ color:#64748b; font-size:12px }
  </style>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">← Voltar</a>
    <h1>Relatórios — Serra Nobre V3.0</h1>
    <div style="margin-left:auto"></div>
    <button id="btnSair" class="btn ghost" style="display:none">Sair</button>
  </header>

  <!-- APP -->
  <main id="app" style="display:none">
    <section class="card">
      <div class="filters">
        <div><label>Data entrega — de</label><input type="date" id="fDataIni"></div>
        <div><label>Data entrega — até</label><input type="date" id="fDataFim"></div>
        <div><label>Horário — de</label><input type="time" id="fHoraIni"></div>
        <div><label>Horário — até</label><input type="time" id="fHoraFim"></div>
        <div><label>Cliente (contém)</label><input type="text" id="fCliente" placeholder="ex.: mercado"></div>
        <div>
          <label>Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
            <option>ABERTO</option>
            <option>EM_ANDAMENTO</option>
            <option>ENTREGUE</option>
            <option>CANCELADO</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnBuscar">Buscar</button>
        <button class="btn ghost" id="btnLimpar">Limpar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Data</th><th>Hora</th><th>Cliente</th><th>Itens</th>
              <th>Total (R$)</th><th>Status</th><th>Pagamento</th><th>Entrega</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- LOGIN (usuário fixo Leo, só senha) -->
  <section id="login" class="login">
    <h3>Entrar</h3>
    <div class="muted" style="margin:4px 0 8px">Usuário: <b>Leo</b></div>
    <div style="display:grid; gap:8px; margin-top:8px">
      <input id="pass" type="password" placeholder="Senha" autocomplete="current-password" />
      <button class="btn" id="btnLogin">Entrar</button>
      <div id="err" class="muted"></div>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === Firebase (mesmo do index) ===
    const firebaseConfig = {
      apiKey: "AIzaSyB3zBW_WhVfNpX5uoJCq-6WysE5XKYKZt4",
      authDomain: "serranobrepedidos.firebaseapp.com",
      projectId: "serranobrepedidos",
      storageBucket: "serranobrepedidos.firebasestorage.app",
      messagingSenderId: "948939268023",
      appId: "1:948939268023:web:3f1f6c18f2c047c82b1232"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // === UI helpers ===
    const $  = (id)=>document.getElementById(id);
    const showApp = (show)=>{
      $("app").style.display   = show ? "" : "none";
      $("login").style.display = show ? "none" : "";
      $("btnSair").style.display = show ? "" : "none";
      if (show) { $("err").textContent = ""; }
    };

    onAuthStateChanged(auth, (u)=> showApp(!!u) );

    // === Login local (usuário fixo Leo) + Auth anônima ===
    const FIX_PASS = "081008";
    $("btnLogin").onclick = async ()=>{
      $("err").textContent = "";
      const p = $("pass").value.trim();
      if (!p) { $("err").textContent = "Informe a senha."; return; }
      if (p !== FIX_PASS) { $("err").textContent = "Senha inválida."; return; }
      try{
        await signInAnonymously(auth);
      }catch(e){
        console.error(e);
        $("err").textContent = "Falha ao autenticar no Firebase. Verifique App Check / domínios.";
      }
    };
    $("btnSair").onclick = ()=> signOut(auth);

    // === Busca de pedidos (com fallback sem índice) ===
    async function buscarPedidos(){
      const di = $("fDataIni").value; // YYYY-MM-DD
      const df = $("fDataFim").value;
      const hi = $("fHoraIni").value;
      const hf = $("fHoraFim").value;
      const cliente = $("fCliente").value.trim().toUpperCase();
      const status  = $("fStatus").value;

      let qRef = collection(db, "pedidos");
      const conds = [];
      if (di) conds.push(where("dataEntregaISO", ">=", di));
      if (df) conds.push(where("dataEntregaISO", "<=", df));
      if (status) conds.push(where("status", "==", status));

      let snap;
      try {
        // pode requerer índice composto (status + orderBy)
        qRef = conds.length
          ? query(qRef, ...conds, orderBy("dataEntregaISO", "desc"), limit(500))
          : query(qRef, orderBy("dataEntregaISO", "desc"), limit(500));
        snap = await getDocs(qRef);
      } catch (e) {
        console.warn("Query com índice falhou, usando fallback:", e?.message||e);
        // fallback: remove status do server e filtra no cliente
        const onlyDateConds = [];
        if (di) onlyDateConds.push(where("dataEntregaISO", ">=", di));
        if (df) onlyDateConds.push(where("dataEntregaISO", "<=", df));
        qRef = onlyDateConds.length
          ? query(collection(db,"pedidos"), ...onlyDateConds, orderBy("dataEntregaISO","desc"), limit(500))
          : query(collection(db,"pedidos"), orderBy("dataEntregaISO","desc"), limit(500));
        snap = await getDocs(qRef);
      }

      const rows = [];
      snap.forEach(d=>{
        const x = d.data();
        if (hi && (x.horaEntrega || "") < hi) return;
        if (hf && (x.horaEntrega || "") > hf) return;
        if (cliente && !(x.cliente||"").toUpperCase().includes(cliente)) return;
        if (status && x.status !== status) return; // caso fallback tenha sido usado

        rows.push(`
          <tr>
            <td>${x.dataEntregaISO||""}</td>
            <td>${x.horaEntrega||""}</td>
            <td>${x.cliente||""}</td>
            <td>${(x.itens||[]).length}</td>
            <td>${Number(x.totalPedido||0).toFixed(2)}</td>
            <td>${x.status||""}</td>
            <td>${x.pagamento||""}</td>
            <td>${x.entrega?.tipo||""}</td>
          </tr>
        `);
      });

      $("tbody").innerHTML = rows.join("") || `<tr><td colspan="8">Sem resultados.</td></tr>`;
    }

    $("btnBuscar").onclick = buscarPedidos;
    $("btnLimpar").onclick = ()=>{
      ["fDataIni","fDataFim","fHoraIni","fHoraFim","fCliente"].forEach(id=>$(id).value="");
      $("fStatus").value = "";
      $("tbody").innerHTML = "";
    };

    // Opcional: carregar automaticamente ao logar
    onAuthStateChanged(auth, (u)=> { if(u) buscarPedidos(); });
  </script>
</body>
</html>
