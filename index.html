<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- favicons -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <link rel="manifest" href="manifest.json" />
  <title>PEDIDOS V3.1.6</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
    h1 { text-align: right; margin-bottom: 10px; font-size: 30px; }
    .logo-header { width: 360px; display: block; margin: 0 auto 10px auto; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .item { border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 10px; }
    .total { font-weight: bold; font-size: 1.2em; }
    button { width: 100%; padding: 10px; background: #008000; color: white; border: none; font-size: 1em; margin-top: 5px; border-radius: 6px; cursor:pointer; }
    .remove { background: #c0392b; }
    .pdf-btn { background: #005580; margin-top: 10px; }
    .pdf-btn.salvar { background: #3d7311; }
    .pdf-btn.compartilhar { background: #b06912; }
    .tipo-select { width: auto; margin-right: 10px; }
    label { font-weight: bold; }
    .field-group { margin-bottom: 12px; }
    .switch-box { display: flex; gap: 20px; justify-content: left; align-items: center; margin-bottom: 12px; }
    #pagamentoOutro { margin-top: 6px; }
    .top-actions { display:flex; gap:8px; margin:6px 0 10px; }
    .top-actions a { background:#0ea5a6; color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:600; }
    .muted{ color:#666; font-size:0.9em }
    #freteValor { font-weight: bold; }
    .frete-row { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .frete-row .inline { display:flex; align-items:center; gap:6px; }
    @media (max-width: 450px) {
      h1 { font-size: 1.1em; }
      .logo-header { width: 110px; }
      .item { padding: 6px; }
      button, .pdf-btn { padding: 7px; font-size: 0.96em; }
      input, select, textarea { padding: 6px; }
      .field-group { margin-bottom: 8px; }
      .top-actions a { padding:6px 8px; font-size:0.9em; }
    }
  </style>
</head>
<body>
  <img src="Serra-Nobre_3.png" alt="Logo" class="logo-header" onerror="this.style.display='none'">
  <h1>PEDIDOS V3.1.6</h1>

  <div class="top-actions">
    <a href="relatorios.html" title="Abrir Relatórios">Relatórios</a>
  </div>

  <div class="field-group">
    <label>Cliente:</label>
    <input list="listaClientes" type="text" id="cliente" autocomplete="off" required
           onfocus="popularClientesMaisUsados()"
           onblur="forcarUppercase(this); preencherEnderecoEIsencaoCliente(); carregarSugestoesProdutosDoCliente();" />
    <datalist id="listaClientes"></datalist>
  </div>

  <div class="field-group">
    <label>Endereço:</label>
    <input type="text" id="endereco" autocomplete="off" required
           onblur="forcarUppercase(this); atualizarFreteUI()"/>
    <small class="muted" id="hint-endereco">
      Se for outra cidade, inclua <b>o nome da cidade</b> no fim do endereço.
      Sem cidade, será considerado <b>Porto Alegre - RS</b>.
    </small>
  </div>

  <div class="field-group">
    <label>Data de Entrega:</label>
    <input type="date" id="entrega" required/>
  </div>

  <div class="field-group">
    <label>Horário de Entrega:</label>
    <input type="time" id="horaEntrega" required/>
  </div>

  <div class="field-group switch-box">
    <label>Entrega/Retirada:</label>
    <label><input type="radio" name="tipoEntrega" value="ENTREGA" checked> Entrega</label>
    <label><input type="radio" name="tipoEntrega" value="RETIRADA"> Retirada</label>
  </div>

  <div class="field-group">
    <label>Valor do Frete:</label>
    <div class="frete-row">
      <div id="freteValor" class="muted">—</div>
      <label class="inline">
        <input type="checkbox" id="isentarFrete" onchange="onToggleIsencaoManual()"/>
        Isentar frete
      </label>
    </div>
  </div>

  <div id="itens"></div>
  <button onclick="adicionarItem()">Adicionar Item</button>

  <hr/>
  <label>Forma de Pagamento:</label>
  <select id="pagamento">
    <option value="PIX">PIX</option>
    <option value="DINHEIRO">DINHEIRO</option>
    <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
    <option value="OUTRO">OUTRO</option>
  </select>
  <input type="text" id="pagamentoOutro" placeholder="Digite outra forma de pagamento" style="display:none"/>

  <hr/>
  <label>Observação geral do pedido:</label>
  <textarea id="obsGeral"></textarea>
  <hr/>

  <button class="pdf-btn"            onclick="gerarPDF(false)">Gerar PDF</button>
  <button class="pdf-btn salvar"     onclick="gerarPDF(true)">Salvar PDF</button>
  <button class="pdf-btn compartilhar" onclick="compartilharPDF()">Compartilhar PDF</button>

  <div id="resumo"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase (module): App + Firestore + Auth -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit,
    updateDoc, increment, doc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3zBW_WhVfNpX5uoJCq-6WysE5XKYKZt4",
    authDomain: "serranobrepedidos.firebaseapp.com",
    projectId: "serranobrepedidos",
    storageBucket: "serranobrepedidos.firebasestorage.app",
    messagingSenderId: "948939268023",
    appId: "1:948939268023:web:3f1f6c18f2c047c82b1232"
  };

  const app = initializeApp(firebaseConfig);

  const auth = getAuth(app);
  const authReady = new Promise((resolve) => {
    onAuthStateChanged(auth, (user) => {
      if (user) resolve(user);
      else signInAnonymously(auth).catch((e) => console.error("Anon auth:", e));
    });
  });

  const db = getFirestore(app);
  window.firebaseReady = authReady;

  // ---- Clientes helpers (iguais aos seus, preservados) ----
  async function getClienteDocByNome(nomeUpper) {
    await authReady;
    const qCli = query(collection(db, "clientes"), where("nome", "==", nomeUpper), limit(1));
    const snap = await getDocs(qCli);
    if (snap.empty) return null;
    return { id: snap.docs[0].id, ref: snap.docs[0].ref, data: snap.docs[0].data() };
  }

  async function salvarCliente(nome, endereco, isentoFrete=false) {
    await authReady;
    const nomeNorm = String(nome || "").trim().toUpperCase();
    const enderecoNorm = String(endereco || "").trim().toUpperCase();
    if (!nomeNorm) return;

    const exist = await getClienteDocByNome(nomeNorm);
    if (exist) {
      const atual = exist.data || {};
      const campos = { atualizadoEm: new Date() };
      if ((atual.endereco || "") !== enderecoNorm) campos.endereco = enderecoNorm;
      if (typeof isentoFrete === "boolean" && (atual.isentoFrete !== isentoFrete)) campos.isentoFrete = isentoFrete;
      await updateDoc(exist.ref, campos);
    } else {
      await addDoc(collection(db, "clientes"), {
        nome: nomeNorm,
        endereco: enderecoNorm,
        isentoFrete: !!isentoFrete,
        compras: 0,
        criadoEm: new Date()
      });
    }
  }

  async function buscarClienteInfo(nomeCliente) {
    await authReady;
    const nome = String(nomeCliente || "").trim().toUpperCase();
    if (!nome) return null;
    const found = await getClienteDocByNome(nome);
    if (!found) return null;
    const d = found.data || {};
    return { endereco: d.endereco || "", isentoFrete: !!d.isentoFrete };
  }

  async function clientesMaisUsados(limitQtd = 50) {
    await authReady;
    const lista = [];
    const qs = await getDocs(collection(db, "clientes"));
    qs.forEach(d => {
      const x = d.data();
      if ((x?.nome || "").trim()) lista.push({ nome: x.nome.trim(), compras: x.compras || 0 });
    });
    lista.sort((a,b)=> b.compras - a.compras || a.nome.localeCompare(b.nome));
    return lista.slice(0, limitQtd).map(x => x.nome);
  }

  async function buscarUltimoPreco(clienteNome, produtoNome) {
    await authReady;
    const nomeCli  = String(clienteNome || "").trim().toUpperCase();
    const nomeProd = String(produtoNome || "").trim();
    if (!nomeCli || !nomeProd) return null;

    const q = query(
      collection(db, "historico_precos"),
      where("cliente", "==", nomeCli),
      where("produto", "==", nomeProd),
      orderBy("data", "desc"),
      limit(1)
    );
    const qs = await getDocs(q);
    if (qs.empty) return null;
    const dados = qs.docs[0].data();
    return typeof dados.preco === "number" ? dados.preco : parseFloat(dados.preco);
  }

  async function produtosDoCliente(nomeCliente) {
    await authReady;
    const nome = String(nomeCliente || "").trim().toUpperCase();
    if (!nome) return [];
    const set = new Set();
    const q = query(
      collection(db, "historico_precos"),
      where("cliente", "==", nome),
      orderBy("data", "desc"),
      limit(1000)
    );
    const qs = await getDocs(q);
    qs.forEach(d => { const p = (d.data().produto || "").trim(); if (p) set.add(p); });
    return [...set].sort((a,b)=>a.localeCompare(b));
  }

  async function registrarPrecoCliente(clienteNome, produtoNome, preco) {
    await authReady;
    const nomeCli  = String(clienteNome || "").trim().toUpperCase();
    const nomeProd = String(produtoNome || "").trim();
    const valor    = parseFloat(preco);
    if (!nomeCli || !nomeProd || isNaN(valor)) return;

    await addDoc(collection(db, "historico_precos"), {
      cliente: nomeCli, produto: nomeProd, preco: valor, data: new Date()
    });

    const found = await getClienteDocByNome(nomeCli);
    if (found) await updateDoc(found.ref, { compras: increment(1), atualizadoEm: new Date() });
  }

  // ======= SAVE com Idempotência =======
  async function savePedidoIdempotente(payload){
    await authReady;
    // chave estável do pedido:
    const key = [
      payload.dataEntregaISO||"",
      payload.horaEntrega||"",
      (payload.cliente||"").toUpperCase(),
      String(payload.subtotal?.toFixed ? payload.subtotal.toFixed(2) : Number(payload.subtotal||0).toFixed(2)),
      String(Array.isArray(payload.itens) ? payload.itens.length : 0)
    ].join("|");

    // checa se já existe
    const qKey = query(collection(db,"pedidos"), where("idempotencyKey","==", key), limit(1));
    const snap = await getDocs(qKey);
    if (!snap.empty){
      // já salvo — retorna o id existente
      return snap.docs[0].id;
    }

    // cria novo
    const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
    await setDoc(doc(collection(db, "pedidos"), id), {
      ...payload,
      idempotencyKey: key,
      createdAt: serverTimestamp()
    });
    return id;
  }

  // Globais p/ script não-module
  window.salvarCliente = salvarCliente;
  window.buscarClienteInfo = buscarClienteInfo;
  window.buscarUltimoPreco = buscarUltimoPreco;
  window.registrarPrecoCliente = registrarPrecoCliente;
  window.carregarSugestoesProdutosDoCliente = async function(){
    await authReady;
    const nome = document.getElementById("cliente").value.trim().toUpperCase();
    const listaProdutos = document.getElementById("listaProdutos");
    if (!listaProdutos) return;
    const nomes = await produtosDoCliente(nome);
    listaProdutos.innerHTML = nomes.map(p => `<option value="${p}"></option>`).join("");
  };
  window.popularClientesMaisUsados = async function(){
    await authReady;
    const lista = await clientesMaisUsados();
    document.getElementById("listaClientes").innerHTML =
      lista.map(n => `<option value="${n}"></option>`).join("");
  };
  window.savePedidoIdempotente = savePedidoIdempotente;
</script>

  <!-- App + PDF -->
  <script>
    // Versão app (para barra de update do SW)
    window.__APP_VERSION = '3.1.6';

    let itens = [{ produto: "", tipo: "KG", quantidade: 0, preco: 0, total: 0, obs: "" }];

    /* Logo cache */
    const LOGO_PATH = 'Serra-Nobre_3.png';
    const LOGO_KEY  = 'logoBase64';
    function blobToDataURL(blob){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});}
    function logoVersionParam(){const d=new Date();return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;}
    async function fetchRepoLogoAsBase64(){const resp=await fetch(`${LOGO_PATH}?v=${logoVersionParam()}`,{cache:'reload'});if(!resp.ok)throw new Error('Logo não carregou');return blobToDataURL(await resp.blob());}
    async function ensureRepoLogoCached(){let b64=localStorage.getItem(LOGO_KEY);if(!b64){try{b64=await fetchRepoLogoAsBase64();localStorage.setItem(LOGO_KEY,b64);}catch(_){b64="";}}return b64;}
    async function getLogoBase64(){return localStorage.getItem(LOGO_KEY) || await ensureRepoLogoCached();}
    function guessImageFormatFromDataURL(u){return u.startsWith('data:image/jpeg')||u.startsWith('data:image/jpg')?'JPEG':'PNG';}

    function forcarUppercase(el){ if(!el || !el.value) return; el.value = el.value.toUpperCase(); }

    // ===== Frete =====
    function appendPOA(str){
      const t = String(str||"").trim();
      if (!t) return t;
      if (/porto\s*alegre/i.test(t)) return t;
      const TEM_CIDADE = /,\s*([A-Za-zÀ-ÿ'.\-\s]{2,})(?:\s*-\s*[A-Za-z]{2})?(?:\s*,\s*Brasil)?\s*$/i;
      if (TEM_CIDADE.test(t)) return t;
      return `${t}, Porto Alegre - RS`;
    }

    const ABS_FRETE_BASE = "https://serranobre-iota.vercel.app";
    async function calcularFrete(enderecoTexto, totalItens){
      const isentoManual = !!document.getElementById('isentarFrete')?.checked;
      const payload = { enderecoTexto, totalItens, clienteIsento: isentoManual };
      try{
        const r = await fetch("/api/calcular-entrega", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error("HTTP "+r.status);
        return await r.json();
      }catch(e1){
        const r2 = await fetch(`${ABS_FRETE_BASE}/api/calcular-entrega`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
        });
        if(!r2.ok) throw new Error("HTTP "+r2.status);
        return await r2.json();
      }
    }

    window.__frete = null;
    async function atualizarFreteUI(){
      try{
        let end = document.getElementById("endereco").value.trim().toUpperCase();
        if(!end){ document.getElementById("freteValor").textContent = "—"; window.__frete=null; return; }
        end = appendPOA(end);
        const subtotal = itens.reduce((s,i)=> s + ((parseFloat(i.quantidade)||0) * (parseFloat(i.preco)||0)), 0);
        const r = await calcularFrete(end, subtotal);
        const isManual = !!document.getElementById('isentarFrete')?.checked;
        const rotuloExtra = isManual ? "(ISENTO manual)" : (r?.labelIsencao || "");
        document.getElementById("freteValor").textContent =
          r?.valorBase==null ? "—" : `R$ ${Number(r.valorBase||0).toFixed(2)} ${rotuloExtra}`;
        window.__frete = r || { valorBase:0, valorCobravel:0, isento:false, labelIsencao:"" };
      }catch(e){
        document.getElementById("freteValor").textContent = "—";
        window.__frete = { valorBase:0, valorCobravel:0, isento:false, labelIsencao:"" };
      }
    }
    window.atualizarFreteUI = atualizarFreteUI;

    async function onToggleIsencaoManual(){
      await atualizarFreteUI();
      const nome = document.getElementById("cliente").value.trim().toUpperCase();
      if (!nome) return;
      const end = document.getElementById("endereco").value.trim().toUpperCase();
      const isento = !!document.getElementById('isentarFrete').checked;
      try { if (typeof window.salvarCliente === "function") await window.salvarCliente(nome, end, isento); } catch(_){}
    }
    window.onToggleIsencaoManual = onToggleIsencaoManual;

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureRepoLogoCached();
      renderItens();
      document.getElementById('pagamento').addEventListener('change', function(){
        document.getElementById('pagamentoOutro').style.display = (this.value === 'OUTRO') ? '' : 'none';
      });
    });

    function criarSelectProduto(i){
      return `<input list="listaProdutos" class="produto" data-index="${i}"
               placeholder="Digite ou selecione"
               value="${itens[i].produto || ''}"
               onblur="preencherUltimoPreco(${i}); atualizarFreteUI();"/>`;
    }
    function criarTipoSelect(i){
      return `<select class="tipo-select" data-index="${i}" onchange="atualizarTipo(${i}, this.value)">
        <option value="KG" ${itens[i].tipo === 'KG' ? 'selected' : ''}>KG</option>
        <option value="UN" ${itens[i].tipo === 'UN' ? 'selected' : ''}>UN</option>
      </select>`;
    }

    function renderItens(){
      salvarCamposAntesRender();
      const container = document.getElementById("itens");
      container.innerHTML = "";
      itens.forEach((item, i) => {
        container.innerHTML += `
        <div class="item">
          <label>Produto:</label>
          ${criarSelectProduto(i)}
          <label>Tipo:</label>
          ${criarTipoSelect(i)}
          <label>Quantidade:</label>
          <input type="number" step="0.01" class="quantidade" data-index="${i}" value="${item.quantidade || ''}" oninput="calcularItem(${i}); atualizarFreteUI();"/>
          <label>Preço Unitário:</label>
          <input type="number" step="0.01" class="preco" data-index="${i}" value="${item.preco || ''}" oninput="calcularItem(${i}); atualizarFreteUI();"/>
          <label>Observação do item:</label>
          <textarea class="obsItem" data-index="${i}" oninput="salvarCamposAntesRender()">${item.obs || ''}</textarea>
          <p class="total">Total do Item: R$ <span id="totalItem_${i}">${(item.total || 0).toFixed(2)}</span></p>
          <button class="remove" onclick="removerItem(${i}); atualizarFreteUI();">Remover Item</button>
        </div>`;
      });
      if (!document.getElementById("listaProdutos")) {
        const dl = document.createElement("datalist"); dl.id = "listaProdutos"; document.body.appendChild(dl);
      }
    }

    function atualizarTipo(i,v){ itens[i].tipo=v; calcularItem(i); }
    function salvarCamposAntesRender(){
      document.querySelectorAll(".item").forEach((el, idx) => {
        if (typeof itens[idx] === "undefined") return;
        const prod  = el.querySelector(".produto")?.value || "";
        const tipo  = el.querySelector(".tipo-select")?.value || "KG";
        const qtd   = el.querySelector(".quantidade")?.value || 0;
        const preco = el.querySelector(".preco")?.value || 0;
        const obs   = el.querySelector(".obsItem")?.value || "";
        itens[idx] = {
          produto: prod, tipo: tipo,
          quantidade: parseFloat(qtd) || 0,
          preco: parseFloat(preco) || 0,
          obs: obs,
          total: (parseFloat(qtd) || 0) * (parseFloat(preco) || 0)
        };
      });
      window.itens = itens;
    }
    function adicionarItem(){ salvarCamposAntesRender(); itens.push({ produto:"", tipo:"KG", quantidade:0, preco:0, total:0, obs:"" }); renderItens(); }
    function removerItem(i){ salvarCamposAntesRender(); itens.splice(i,1); if(!itens.length) itens.push({ produto:"", tipo:"KG", quantidade:0, preco:0, total:0, obs:"" }); renderItens(); }
    function calcularItem(i){
      const tipo = document.querySelectorAll(".tipo-select")[i]?.value || "KG";
      const q = document.querySelectorAll(".quantidade")[i]?.value || 0;
      const p = document.querySelectorAll(".preco")[i]?.value || 0;
      itens[i].quantidade = parseFloat(q) || 0;
      itens[i].preco = parseFloat(p) || 0;
      itens[i].tipo = tipo;
      itens[i].total = (parseFloat(q) || 0) * (parseFloat(p) || 0);
      const tgt = document.getElementById(`totalItem_${i}`);
      if(tgt) tgt.innerText = itens[i].total ? itens[i].total.toFixed(2) : "—";
    }
    function camposObrigatoriosPreenchidos(){
      return document.getElementById("cliente").value.trim()
          && document.getElementById("endereco").value.trim()
          && document.getElementById("entrega").value
          && document.getElementById("horaEntrega").value;
    }

    // ===== Helpers PDF e caixas com altura dinâmica =====
    function formatarData(s){ if(!s) return ""; const [a,m,d]=s.split("-"); return `${d}/${m}/${a.slice(-2)}`; }
    function diaDaSemanaExtenso(s){ if(!s) return ""; const d=new Date(s+"T00:00:00"); return d.toLocaleDateString('pt-BR',{weekday:'long'}).toUpperCase(); }
    function splitToWidth(doc,t,w){ return doc.splitTextToSize(t||"", w); }

    function drawLabeledBox(doc, x, y, w, title, value, opts={}){
      const { titleSize=8, valueSize=8, pad=3, maxLines=4 } = opts;
      doc.setFont("helvetica","bold"); doc.setFontSize(titleSize);
      // mede o texto (valor) para definir altura
      doc.setFont("helvetica","normal"); doc.setFontSize(valueSize);
      const lines = splitToWidth(doc, String(value||""), w-2);
      const use = lines.slice(0, maxLines);
      const rowH = Math.max(10, pad*2 + use.length*5);
      doc.setDrawColor(0); doc.setLineWidth(0.2);
      doc.rect(x, y, w, rowH, "S");
      // título centralizado no topo (sem sobrepor conteúdo)
      doc.setFont("helvetica","bold"); doc.setFontSize(titleSize);
      doc.text(title, x+w/2, y+4.2, {align:"center"});
      // valor centralizado verticalmente
      doc.setFont("helvetica","normal"); doc.setFontSize(valueSize);
      const usable = rowH - 8; // desconta título
      const block = (use.length-1)*5;
      const y0 = y + 7 + (usable - block)/2;
      use.forEach((ln,i)=>doc.text(ln, x+w/2, y0 + i*5, {align:"center"}));
      return rowH;
    }

    async function preencherEnderecoEIsencaoCliente(){
      const n=(document.getElementById("cliente").value||"").trim().toUpperCase();
      if(!n) return;
      try{
        const info = (typeof window.buscarClienteInfo==="function") ? await window.buscarClienteInfo(n) : null;
        if(info){
          if(info.endereco){ const el=document.getElementById("endereco"); el.value=String(info.endereco||"").toUpperCase(); }
          const chk = document.getElementById("isentarFrete");
          if (chk) chk.checked = !!info.isentoFrete;
        }
      }catch(_){}
      atualizarFreteUI();
    }
    window.preencherEnderecoEIsencaoCliente = preencherEnderecoEIsencaoCliente;

    async function preencherUltimoPreco(index){
      const nome=(document.getElementById("cliente").value||"").trim().toUpperCase();
      const el=document.querySelectorAll(".produto")[index];
      if(!el) return; const prod=el.value.trim();
      if(!nome||!prod||typeof window.buscarUltimoPreco!=="function") return;
      const preco=await window.buscarUltimoPreco(nome, prod);
      if(preco!==null){
        const input=document.querySelectorAll(".preco")[index];
        if(!input) return;
        input.value=preco; itens[index].preco=parseFloat(preco)||0; calcularItem(index);
        atualizarFreteUI();
      }
    }
    window.preencherUltimoPreco = preencherUltimoPreco;

    async function montarPDF(querSalvarNoBanco){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"portrait", unit:"mm", format:[72,297] });

      const margemX=2, larguraCaixa=68;
      const W_PROD=23.5, W_QDE=13, W_UNIT=13, W_TOTAL=18.5;
      let y=10;

      try{
        const b64=await getLogoBase64();
        if(b64){ doc.addImage(b64, guessImageFormatFromDataURL(b64), 20, y, 32, 12, '', 'FAST'); y+=14; }
        else { y+=2; }
      }catch(_){ y+=2; }

      // CLIENTE (altura dinâmica)
      y += drawLabeledBox(doc, margemX, y, larguraCaixa,
        "CLIENTE", (document.getElementById("cliente").value||"").toUpperCase(),
        { titleSize:8, valueSize:8, maxLines:3 }) + 1;

      // ENDEREÇO (altura dinâmica — evita sobrepor título)
      y += drawLabeledBox(doc, margemX, y, larguraCaixa,
        "ENDEREÇO", (document.getElementById("endereco").value||"").toUpperCase(),
        { titleSize:8, valueSize:8, maxLines:4 }) + 1;

      const diaSemana = diaDaSemanaExtenso(document.getElementById("entrega").value);
      doc.rect(margemX,y,larguraCaixa,10,"S");
      doc.setFont("helvetica","bold"); doc.setFontSize(9);
      doc.text("DIA DA SEMANA:", margemX+3, y+6);
      doc.text(diaSemana, margemX+larguraCaixa/2+12, y+6, {align:"center"});
      y+=11;

      doc.setFont("helvetica","bold"); doc.setFontSize(7);
      doc.rect(margemX,y,larguraCaixa/2,10,"S");
      doc.rect(margemX+larguraCaixa/2,y,larguraCaixa/2,10,"S");
      doc.text("DATA ENTREGA", margemX+larguraCaixa/4, y+4, {align:"center"});
      doc.text("HORÁRIO ENTREGA", margemX+3*larguraCaixa/4, y+4, {align:"center"});
      doc.setFont("helvetica","normal"); doc.setFontSize(9);
      doc.text(formatarData(document.getElementById("entrega").value), margemX+larguraCaixa/4, y+8, {align:"center"});
      doc.text(document.getElementById("horaEntrega").value, margemX+3*larguraCaixa/4, y+8, {align:"center"});
      y+=12;

      doc.setLineWidth(1.1);
      doc.rect(margemX+larguraCaixa*0.235, y, larguraCaixa*0.53, 10, "S");
      doc.setLineWidth(0.2);
      doc.setFont("helvetica","bold"); doc.setFontSize(10);
      const tipoEntrega=document.querySelector('input[name="tipoEntrega"]:checked').value;
      doc.text(tipoEntrega, margemX+larguraCaixa/2, y+6.5, {align:"center"});
      y+=12;

      // Título da tabela
      doc.setFont("helvetica","bold"); doc.setFontSize(7);
      doc.rect(margemX,y,W_PROD,10,"S");
      doc.rect(margemX+W_PROD,y,W_QDE,10,"S");
      doc.rect(margemX+W_PROD+W_QDE,y,W_UNIT,10,"S");
      doc.rect(margemX+W_PROD+W_QDE+W_UNIT,y,W_TOTAL,10,"S");
      doc.text("PRODUTO", margemX+W_PROD/2, y+6, {align:"center"});
      doc.text("QDE", margemX+W_PROD+W_QDE/2, y+6, {align:"center"});
      doc.text("R$ UNIT.", margemX+W_PROD+W_QDE+W_UNIT/2, y+6, {align:"center"});
      const valorX=margemX+W_PROD+W_QDE+W_UNIT+W_TOTAL/2;
      doc.text("VALOR", valorX, y+4, {align:"center"});
      doc.text("PRODUTO", valorX, y+8.5, {align:"center"});
      y+=12;

      let subtotal = 0;
      doc.setFont("helvetica","normal"); doc.setFontSize(9);

      for (let i=0;i<itens.length;i++){
        const it = itens[i];
        const prod = it.produto || "";
        const qtdStr  = (it.quantidade || 0).toString();
        const tipo = it.tipo || "KG";
        const precoNum = parseFloat(it.preco) || 0;
        const totalNum = (parseFloat(it.quantidade)||0) * precoNum;

        const prodLines = splitToWidth(doc, prod, W_PROD-2).slice(0,3);
        const rowH = Math.max(14, 6 + prodLines.length*5);

        doc.rect(margemX,y,W_PROD,rowH,"S");
        doc.rect(margemX+W_PROD,y,W_QDE,rowH,"S");
        doc.rect(margemX+W_PROD+W_QDE,y,W_UNIT,rowH,"S");
        doc.rect(margemX+W_PROD+W_QDE+W_UNIT,y,W_TOTAL,rowH,"S");

        // centraliza nas 4 colunas
        const center = (cx, lines)=> {
          const block=(lines.length-1)*5; const base=y+(rowH - block)/2;
          lines.forEach((ln,k)=>doc.text(ln, cx, base + k*5, {align:"center"}));
        }
        center(margemX+W_PROD/2, prodLines);
        center(margemX+W_PROD+W_QDE/2, qtdStr ? [qtdStr, tipo] : [""]);
        center(margemX+W_PROD+W_QDE+W_UNIT/2, precoNum ? ["R$", precoNum.toFixed(2).replace(".", ",")] : ["—"]);
        center(margemX+W_PROD+W_QDE+W_UNIT+W_TOTAL/2, (precoNum && it.quantidade) ? ["R$", totalNum.toFixed(2).replace(".", ",")] : ["—"]);

        y += rowH;

        const obs = (it.obs || "").trim();
        if (obs){
          const corpoLines = splitToWidth(doc, obs.toUpperCase(), larguraCaixa-6);
          const obsH = 9 + corpoLines.length*5;
          doc.rect(margemX,y,larguraCaixa,obsH,"S");
          doc.setFont("helvetica","bold"); doc.setFontSize(9);
          const titulo="OBSERVAÇÕES:"; const tx=margemX+3, ty=y+6;
          doc.text(titulo, tx, ty);
          doc.line(tx, ty+0.8, tx+doc.getTextWidth(titulo), ty+0.8);
          doc.setFont("helvetica","normal");
          let baseY=y+12; corpoLines.forEach((ln,ix)=>doc.text(ln, margemX+3, baseY+ix*5));
          y += obsH;
        }

        if (tipo === "UN"){
          doc.setFontSize(7); doc.setFont("helvetica","italic");
          doc.text("(*) ESTE ITEM ESTÁ EM UNIDADES! (NÃO EM KG).", margemX+5, y+4);
          doc.setFont("helvetica","normal"); doc.setFontSize(9);
          y += 4;
        }

        subtotal += totalNum;
        if (i < itens.length - 1) y += 2;
      }

      // Frete + Total final
      let frete = window.__frete;
      try{
        if(!frete){
          const end = document.getElementById("endereco").value.trim().toUpperCase();
          frete = await calcularFrete(appendPOA(end), subtotal);
        }
      }catch(_){ frete = { valorBase:0, valorCobravel:0, isento:false, labelIsencao:"" }; }

      y += 2;
      const freteBoxH = 10;
      doc.rect(margemX, y, larguraCaixa, freteBoxH, "S");
      doc.setFont("helvetica","normal"); doc.setFontSize(10);
      const isIsentoManual = !!document.getElementById('isentarFrete')?.checked;
      const isIsento = isIsentoManual || !!frete?.isento;
      const freteMostrar = isIsento ? "ISENTO DE FRETE" : ("R$ " + Number(frete?.valorBase || 0).toFixed(2));
      const fLines = splitToWidth(doc, freteMostrar, larguraCaixa - 6);
      const block=(fLines.length-1)*5; const baseY = y + (freteBoxH - block)/2 + 3;
      fLines.forEach((ln,i)=>doc.text(ln, margemX+larguraCaixa/2, baseY+i*5, {align:"center"}));
      y += freteBoxH + 3;

      const totalGeral = subtotal + Number(frete?.valorCobravel||0);

      doc.setFont("helvetica","bold"); doc.setLineWidth(1.1);
      doc.rect(margemX,y,larguraCaixa,12,"S");
      doc.text("TOTAL DO PEDIDO", margemX+larguraCaixa/2, y+4.5, {align:"center"});
      doc.setFontSize(10);
      doc.text("R$ " + totalGeral.toFixed(2), margemX+larguraCaixa/2, y+9, {align:"center"});
      y += 15;

      const obsG=(document.getElementById("obsGeral").value||"").trim();
      if (obsG){
        const corpoLines=splitToWidth(doc, obsG.toUpperCase(), larguraCaixa-6);
        const h=9+corpoLines.length*5;
        doc.rect(margemX,y,larguraCaixa,h,"S");
        doc.setFont("helvetica","bold"); doc.setFontSize(9);
        const titulo="OBSERVAÇÃO DO PEDIDO:"; const tx=margemX+3, ty=y+6;
        doc.text(titulo, tx, ty); doc.line(tx, ty+0.8, tx+doc.getTextWidth(titulo), ty+0.8);
        doc.setFont("helvetica","normal");
        let baseY=y+12; corpoLines.forEach((ln,ix)=>doc.text(ln, margemX+3, baseY+ix*5));
        y += h + 3;
      }

      // Persistências de cliente/histórico
      try{
        if (typeof window.salvarCliente === "function") {
          await window.salvarCliente(
            document.getElementById("cliente").value.trim().toUpperCase(),
            document.getElementById("endereco").value.trim().toUpperCase(),
            !!document.getElementById('isentarFrete')?.checked
          );
        }
        const nomeCli=document.getElementById("cliente").value.trim().toUpperCase();
        if (typeof window.registrarPrecoCliente === "function") {
          await Promise.all(
            itens.filter(i=> (i?.produto||"").trim() && !isNaN(parseFloat(i?.preco)))
                 .map(i=> window.registrarPrecoCliente(nomeCli, String(i.produto).trim(), parseFloat(i.preco)))
          );
        }
      }catch(e){ console.error(e); }

      // Monta payload p/ /pedidos (salva só quando solicitado)
      const cliente   = document.getElementById("cliente").value.trim().toUpperCase();
      const pagamento = document.getElementById("pagamento").value;
      const endereco  = document.getElementById("endereco").value.trim().toUpperCase();
      const entregaISO= document.getElementById("entrega").value;
      const hora      = document.getElementById("horaEntrega").value;
      const tipoEnt   = document.querySelector('input[name="tipoEntrega"]:checked').value;
      const isentoMan = !!document.getElementById('isentarFrete')?.checked;

      const payload = {
        cliente,
        pagamento,
        itens: itens.map(i=>({ produto:i.produto, tipo:i.tipo, quantidade:i.quantidade, precoUnit:i.preco, total:i.total, obs:i.obs||"" })),
        subtotal: Number(subtotal.toFixed(2)),
        totalPedido: Number((subtotal + Number(window.__frete?.valorCobravel||0)).toFixed(2)),
        entrega: {
          tipo: tipoEnt,
          endereco,
          km: window.__frete?.km ?? null,
          min: window.__frete?.min ?? null,
          valorBase: window.__frete?.valorBase ?? 0,
          valorCobravel: window.__frete?.valorCobravel ?? 0,
          isento: !!window.__frete?.isento || isentoMan,
          isentoManual: isentoMan,
          status: "PENDENTE",
          tier: window.__frete?.tier || null,
          labelIsencao: isentoMan ? "(ISENTO manual)" : (window.__frete?.labelIsencao || "")
        },
        dataEntregaISO: entregaISO,
        horaEntrega: hora,
        anoMes: entregaISO ? entregaISO.slice(0,7) : "",
        status: "ABERTO",
        vendedor: "Leo",
        obsGeral: (document.getElementById("obsGeral").value||"").trim().toUpperCase()
      };

      if (querSalvarNoBanco && typeof window.savePedidoIdempotente === "function"){
        try{ await window.savePedidoIdempotente(payload); }catch(e){ console.warn("savePedido falhou:", e); }
      }

      const nomeCliente=cliente;
      const [ano,mes,dia]=(entregaISO||"").split("-");
      const nomeArquivo=`Pedido_${nomeCliente.replace(/\s+/g,'_').replace(/[^A-Z0-9_]/g,'')}_${dia||'DD'}-${mes||'MM'}-${ano||'AAAA'}.pdf`;

      return { doc, nomeArquivo };
    }

    // ===== Ações com trava anti-duplo clique =====
    async function gerarPDF(apenasSalvar=false){
      if (window.__busy) return;
      window.__busy = true;
      try{
        if (!camposObrigatoriosPreenchidos()) { alert("Preencha Cliente, Endereço, Data e Horário."); return; }
        forcarUppercase(document.getElementById("cliente"));
        forcarUppercase(document.getElementById("endereco"));
        salvarCamposAntesRender();

        const { doc, nomeArquivo } = await montarPDF(/*querSalvarNoBanco*/apenasSalvar);
        if (apenasSalvar) doc.save(nomeArquivo);
        else window.open(doc.output('bloburl'), '_blank');
      } finally {
        window.__busy = false;
      }
    }
    window.gerarPDF = gerarPDF;

    async function compartilharPDF(){
      if (window.__busy) return;
      window.__busy = true;
      try{
        if (!camposObrigatoriosPreenchidos()) { alert("Preencha Cliente, Endereço, Data e Horário."); return; }
        salvarCamposAntesRender();
        const { doc, nomeArquivo } = await montarPDF(/*querSalvarNoBanco*/true);
        if (navigator.canShare && window.Blob){
          const blob = await doc.output("blob");
          const file = new File([blob], nomeArquivo, { type: "application/pdf" });
          if (navigator.canShare({ files:[file] })) await navigator.share({ files:[file], title:"Pedido Serra Nobre", text:"Segue pedido em PDF" });
          else {
            const url = URL.createObjectURL(blob); window.open(url, "_blank"); setTimeout(()=>URL.revokeObjectURL(url), 20000);
          }
        } else {
          const blob = await doc.output("blob"); const url = URL.createObjectURL(blob);
          window.open(url, "_blank"); setTimeout(()=>URL.revokeObjectURL(url), 20000);
        }
      } finally {
        window.__busy = false;
      }
    }
    window.compartilharPDF = compartilharPDF;

    // ===== Service Worker (update rápido) =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') reg.update(); });
          setInterval(() => reg.update(), 10 * 60 * 1000);
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing; if (!nw) return;
            nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) reg.waiting && reg.waiting.postMessage('SKIP_WAITING');
            });
          });
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!window.__reloadedBySW) { window.__reloadedBySW = true; location.reload(); }
          });
        } catch (e) {}
      });
    }
  </script>

  <datalist id="listaProdutos"></datalist>
</body>
</html>
