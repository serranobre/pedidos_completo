<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- favicons (caminhos relativos p/ GitHub Pages) -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <!-- CORRIGIDO -->
  <link rel="manifest" href="/manifest.json" />
  <title>PEDIDOS V3.0</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
    h1 { text-align: right; margin-bottom: 10px; font-size: 30px; }
    .logo-header { width: 360px; display: block; margin: 0 auto 10px auto; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .item { border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 10px; }
    .total { font-weight: bold; font-size: 1.2em; }
    button { width: 100%; padding: 10px; background: #008000; color: white; border: none; font-size: 1em; margin-top: 5px; border-radius: 6px; cursor:pointer; }
    .remove { background: #c0392b; }
    .pdf-btn { background: #005580; margin-top: 10px; }
    .pdf-btn.salvar { background: #3d7311; }
    .pdf-btn.compartilhar { background: #b06912; }
    .tipo-select { width: auto; margin-right: 10px; }
    label { font-weight: bold; }
    .field-group { margin-bottom: 12px; }
    .switch-box { display: flex; gap: 20px; justify-content: left; align-items: center; margin-bottom: 12px; }
    #pagamentoOutro { margin-top: 6px; }
    .top-actions { display:flex; gap:8px; margin:6px 0 10px; }
    .top-actions a { background:#0ea5a6; color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:600; }
    .muted{ color:#666; font-size:0.9em }
    #freteValor { font-weight: bold; }
    @media (max-width: 450px) {
      h1 { font-size: 1.1em; }
      .logo-header { width: 110px; }
      .item { padding: 6px; }
      button, .pdf-btn { padding: 7px; font-size: 0.96em; }
      input, select, textarea { padding: 6px; }
      .field-group { margin-bottom: 8px; }
      .top-actions a { padding:6px 8px; font-size:0.9em; }
    }
  </style>
</head>
<body>
  <img src="Serra-Nobre_3.png" alt="Logo" class="logo-header" onerror="this.style.display='none'">
  <h1>PEDIDOS V3.0</h1>

  <div class="top-actions">
    <a href="relatorios.html" title="Abrir Relatórios">Relatórios</a>
  </div>

  <div class="field-group">
    <label>Cliente:</label>
    <input list="listaClientes" type="text" id="cliente" autocomplete="off" required
           onfocus="popularClientesMaisUsados()"
           onblur="preencherEnderecoCliente(); carregarSugestoesProdutosDoCliente();" />
    <datalist id="listaClientes"></datalist>
  </div>

  <div class="field-group">
    <label>Endereço:</label>
    <input type="text" id="endereco" autocomplete="off" required onblur="atualizarFreteUI()"/>
    <small class="muted">
      Se for outra cidade, inclua <b>o nome da cidade</b> no fim do endereço.  
      Sem cidade, será considerado <b>Porto Alegre - RS</b>.
    </small>
  </div>

  <div class="field-group">
    <label>Data de Entrega:</label>
    <input type="date" id="entrega" required/>
  </div>

  <div class="field-group">
    <label>Horário de Entrega:</label>
    <input type="time" id="horaEntrega" required/>
  </div>

  <div class="field-group switch-box">
    <label>Entrega/Retirada:</label>
    <label><input type="radio" name="tipoEntrega" value="ENTREGA" checked> Entrega</label>
    <label><input type="radio" name="tipoEntrega" value="RETIRADA"> Retirada</label>
  </div>

  <div class="field-group">
    <label>Valor do Frete:</label>
    <div id="freteValor" class="muted">—</div>
  </div>

  <div id="itens"></div>
  <button onclick="adicionarItem()">Adicionar Item</button>

  <hr/>
  <label>Forma de Pagamento:</label>
  <select id="pagamento">
    <option value="PIX">PIX</option>
    <option value="DINHEIRO">DINHEIRO</option>
    <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
    <option value="OUTRO">OUTRO</option>
  </select>
  <input type="text" id="pagamentoOutro" placeholder="Digite outra forma de pagamento" style="display:none"/>

  <hr/>
  <label>Observação geral do pedido:</label>
  <textarea id="obsGeral"></textarea>
  <hr/>

  <button class="pdf-btn" onclick="gerarPDF(false)">Gerar PDF</button>
  <button class="pdf-btn salvar" onclick="gerarPDF(true)">Salvar PDF</button>
  <button class="pdf-btn compartilhar" onclick="compartilharPDF()">Compartilhar PDF</button>

  <div id="resumo"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    ... <!-- (mantém seu bloco Firebase original aqui, não alterei nada) -->
  </script>

  <!-- App + PDF -->
  <script>
    let itens = [{ produto: "", tipo: "KG", quantidade: 0, preco: 0, total: 0, obs: "" }];

    // -------- FRETE --------
    function appendPOA(str){
      const t = String(str||"").trim();
      if (!t) return t;
      if (/porto\s*alegre/i.test(t)) return t;
      const TEM_CIDADE = /,\s*([A-Za-zÀ-ÿ'.\-\s]{2,})(?:\s*-\s*[A-Za-z]{2})?(?:\s*,\s*Brasil)?\s*$/i;
      if (TEM_CIDADE.test(t)) return t;
      return `${t}, Porto Alegre - RS`;
    }

    const ABS_FRETE_BASE = "https://serranobre-iota.vercel.app";
    async function calcularFrete(enderecoTexto, totalItens){
      const payload = { enderecoTexto, totalItens };
      try{
        const r = await fetch("/api/calcular-entrega", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          const txt = await r.text();
          console.error("Frete HTTP", r.status, txt);
          throw new Error("HTTP "+r.status);
        }
        return await r.json();
      }catch(e1){
        try{
          const r2 = await fetch(`${ABS_FRETE_BASE}/api/calcular-entrega`, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if(!r2.ok){
            const txt2 = await r2.text();
            console.error("Frete ABS HTTP", r2.status, txt2);
            throw new Error("HTTP "+r2.status);
          }
          return await r2.json();
        }catch(e2){
          console.warn("Falha no cálculo de frete:", e1, e2);
          throw e2;
        }
      }
    }

    window.__frete = null;
    async function atualizarFreteUI(){
      try{
        let end = document.getElementById("endereco").value.trim();
        if(!end){ document.getElementById("freteValor").textContent = "—"; window.__frete=null; return; }
        end = appendPOA(end);
        const subtotal = itens.reduce((s,i)=> s + ((parseFloat(i.quantidade)||0) * (parseFloat(i.preco)||0)), 0);
        const r = await calcularFrete(end, subtotal);
        document.getElementById("freteValor").textContent =
          r?.valorBase==null ? "—" : `R$ ${Number(r.valorBase||0).toFixed(2)} ${r.labelIsencao||""}`;
        window.__frete = r || { valorBase:0, valorCobravel:0, isento:false, labelIsencao:"" };
      }catch(e){
        document.getElementById("freteValor").textContent = "—";
        window.__frete = { valorBase:0, valorCobravel:0, isento:false, labelIsencao:"" };
      }
    }
    window.atualizarFreteUI = atualizarFreteUI;

    // ... (restante do seu código de itens, PDF, salvarPedido, etc igual ao original)
  </script>
</body>
</html>
