<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SERRA NOBRE V3.0</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:10px; background:#f4f4f4; }
    header { display:flex; gap:12px; align-items:center; }
    h1 { margin:0 auto; font-size:24px; }
    .logo-header { width:240px; display:block; margin:10px auto; }
    .top-actions { margin:10px 0; display:flex; gap:8px; }
    .top-actions a, .top-actions button { padding:10px 12px; border-radius:8px; border:0; cursor:pointer; }
    .btn { background:#0ea5a6; color:#fff; }
    .btn.secondary { background:#0f766e; color:#fff; }
    input, select, textarea { width:100%; padding:8px; margin:5px 0; box-sizing:border-box; }
    .item { border:1px solid #ccc; padding:10px; background:#fff; margin-bottom:10px; }
    .total { font-weight:bold; font-size:1.2em; }
    button.action { width:100%; padding:10px; background:#008000; color:#fff; border:none; font-size:1em; margin-top:5px; border-radius:6px; }
    .remove { background:#c0392b; }
    .pdf-btn { background:#005580; margin-top:10px; }
    .pdf-btn.salvar { background:#3d7311; }
    .pdf-btn.compartilhar { background:#b06912; }
    .field-group { margin-bottom:12px; }
    #freteValor { font-weight:bold; color:#333; }
    @media(max-width:450px){
      h1 { font-size:1.1em; }
      .logo-header { width:120px; }
      button.action { font-size:0.9em; }
    }
  </style>
</head>
<body>
  <img src="Serra-Nobre_3.png" alt="Logo" class="logo-header" onerror="this.style.display='none'">
  <header>
    <div class="top-actions">
      <a class="btn" href="relatorios.html">Relatórios</a>
    </div>
    <h1>SERRA NOBRE V3.0</h1>
  </header>

  <div class="field-group">
    <label>Cliente:</label>
    <input type="text" id="cliente" autocomplete="off" required />
  </div>

  <div class="field-group">
    <label>Endereço:</label>
    <input type="text" id="endereco" autocomplete="off" required/>
  </div>

  <div class="field-group">
    <label>Data de Entrega:</label>
    <input type="date" id="entrega" required/>
  </div>

  <div class="field-group">
    <label>Horário de Entrega:</label>
    <input type="time" id="horaEntrega" required/>
  </div>

  <div id="itens"></div>
  <button class="action" onclick="adicionarItem()">Adicionar Item</button>

  <hr/>
  <label>Forma de Pagamento:</label>
  <select id="pagamento">
    <option value="PIX">PIX</option>
    <option value="DINHEIRO">DINHEIRO</option>
    <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
    <option value="A PRAZO">A PRAZO</option>
  </select>

  <hr/>
  <label>Valor do Frete:</label>
  <div id="freteValor">—</div>

  <hr/>
  <label>Observação geral do pedido:</label>
  <textarea id="obsGeral"></textarea>
  <hr/>

  <button class="pdf-btn" onclick="gerarPDF(false)">Gerar PDF</button>
  <button class="pdf-btn salvar" onclick="gerarPDF(true)">Salvar PDF</button>
  <button class="pdf-btn compartilhar" onclick="compartilharPDF()">Compartilhar PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase (modular v11) para salvar pedidos -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // >>>>> SUBSTITUA pelo seu config do Firebase (mesmo usado nos relatórios) <<<<<
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:YYYY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    let authReady = new Promise((resolve) => {
      onAuthStateChanged(auth, (u)=>{
        if(u) resolve(true);
      });
      signInAnonymously(auth).catch(()=>{});
    });

    // ====== Lógica da página ======
    window.itens = [{ produto:"", quantidade:0, preco:0, total:0 }];

    function renderItens(){
      const c = document.getElementById("itens");
      c.innerHTML = "";
      window.itens.forEach((it,i)=>{
        c.innerHTML += `
          <div class="item">
            <label>Produto:</label>
            <input type="text" class="produto" data-i="${i}" value="${it.produto}" oninput="salvarCampos()"/>
            <label>Qtd:</label>
            <input type="number" step="0.01" class="quant" data-i="${i}" value="${it.quantidade}" oninput="salvarCampos()"/>
            <label>Preço Unit:</label>
            <input type="number" step="0.01" class="preco" data-i="${i}" value="${it.preco}" oninput="salvarCampos()"/>
            <p class="total">Total Item: R$ <span>${it.total.toFixed(2)}</span></p>
            <button class="remove action" onclick="removerItem(${i})">Remover</button>
          </div>
        `;
      });
      atualizarFreteUI();
    }
    window.renderItens = renderItens;

    function salvarCampos(){
      document.querySelectorAll(".item").forEach((el,idx)=>{
        const p = el.querySelector(".produto").value;
        const q = parseFloat(el.querySelector(".quant").value)||0;
        const pr= parseFloat(el.querySelector(".preco").value)||0;
        window.itens[idx] = { produto:p, quantidade:q, preco:pr, total:q*pr };
        el.querySelector(".total span").textContent = (q*pr).toFixed(2);
      });
      atualizarFreteUI();
    }
    window.salvarCampos = salvarCampos;

    function adicionarItem(){ window.itens.push({ produto:"",quantidade:0,preco:0,total:0 }); renderItens(); }
    function removerItem(i){ window.itens.splice(i,1); if(!window.itens.length) window.itens.push({ produto:"",quantidade:0,preco:0,total:0 }); renderItens(); }
    window.adicionarItem = adicionarItem;
    window.removerItem   = removerItem;

    // === Frete Backend (Vercel API) ===
    async function calcularFrete(endereco, totalItens){
      const resp = await fetch("/api/calcular-entrega", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ enderecoTexto:endereco, totalItens })
      });
      if(!resp.ok) throw new Error("Erro frete");
      return await resp.json();
    }

    async function atualizarFreteUI(){
      try{
        const end = document.getElementById("endereco").value.trim();
        if(!end) { document.getElementById("freteValor").textContent = "—"; return; }
        const tot = window.itens.reduce((s,it)=>s+it.total,0);
        const r = await calcularFrete(end, tot);
        document.getElementById("freteValor").textContent =
          r.valorBase==null ? "—" : `R$ ${r.valorBase.toFixed(2)} ${r.labelIsencao||""}`;
        window.__frete = r;
      }catch(e){
        document.getElementById("freteValor").textContent = "—";
        console.error(e);
      }
    }
    window.atualizarFreteUI = atualizarFreteUI;

    // === Salvar pedido no Firestore ===
    async function savePedido(payload){
      await authReady;
      const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      await setDoc(doc(collection(db, "pedidos"), id), {
        ...payload,
        createdAt: serverTimestamp()
      });
      return id;
    }
    window.savePedido = savePedido;

    // === PDF helpers ===
    async function imgToDataURL(src){
      try{
        const r = await fetch(src);
        const b = await r.blob();
        return await new Promise((res,rej)=>{
          const fr = new FileReader();
          fr.onload = ()=>res(fr.result);
          fr.onerror = rej;
          fr.readAsDataURL(b);
        });
      }catch(_){ return null; }
    }

    async function gerarPDF(apenasSalvar=false){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const cliente = document.getElementById("cliente").value.trim();
      const endereco= document.getElementById("endereco").value.trim();
      const entregaISO = document.getElementById("entrega").value;
      const hora    = document.getElementById("horaEntrega").value;
      const pagamento = document.getElementById("pagamento").value;
      const obs     = document.getElementById("obsGeral").value.trim();
      const totalItens = window.itens.reduce((s,it)=>s+it.total,0);

      // Frete (se ainda não calculado)
      let frete = window.__frete || { valorBase:0, valorCobravel:0, labelIsencao:"" };
      try {
        if (!window.__frete) frete = await calcularFrete(endereco, totalItens);
      } catch(e){ console.error("Frete falhou", e); }
      const totalPedido = totalItens + (frete.valorCobravel||0);

      // Salvar pedido no Firestore (ENTREGA por padrão; ajuste se tiver retirada)
      const payload = {
        cliente,
        pagamento,
        itens: window.itens.map(i=>({ produto:i.produto, tipo:"KG", quantidade:i.quantidade, precoUnit:i.preco, total:i.total, obs:"" })),
        totalPedido: Number(totalPedido.toFixed(2)),
        entrega: {
          tipo: "ENTREGA",
          endereco,
          km: frete.km ?? null,
          min: frete.min ?? null,
          valorBase: frete.valorBase ?? 0,
          valorCobravel: frete.valorCobravel ?? 0,
          isento: !!frete.isento,
          status: "PENDENTE",
          tier: frete.tier || null,
          labelIsencao: frete.labelIsencao || ""
        },
        dataEntregaISO: entregaISO,
        horaEntrega: hora,
        anoMes: entregaISO ? entregaISO.slice(0,7) : "",
        status: "ABERTO",
        vendedor: "Leo"
      };
      try { await savePedido(payload); } catch(e) { console.warn("Não salvou no Firestore (ver regras/config):", e); }

      // --- PDF ---
      // Logo grande (dobrado)
      const logo = await imgToDataURL("Serra-Nobre_3.png") || await imgToDataURL("icons/icon-192.png");
      if (logo) {
        try {
          doc.addImage(logo, "PNG", 65, 10, 80, 30); // logo maior que o normal
        } catch(_) {}
      }
      doc.setFontSize(16);
      doc.text("SERRA NOBRE V3.0", 105, 48, {align:"center"});

      // Dados
      doc.setFontSize(12);
      doc.text(`Cliente: ${cliente}`, 10, 60);
      doc.text(`Endereço: ${endereco}`, 10, 68);
      doc.text(`Entrega: ${entregaISO} ${hora}`, 10, 76);

      // Itens
      let y = 90;
      window.itens.forEach(it=>{
        doc.text(`${it.produto} - ${it.quantidade} x R$ ${it.preco.toFixed(2)} = R$ ${it.total.toFixed(2)}`, 10, y);
        y += 8;
      });

      // Pagamento
      y += 4;
      doc.text(`Pagamento: ${pagamento}`, 10, y); y+=8;

      // Frete (após forma de pagamento)
      doc.text(`Frete: R$ ${(frete.valorBase??0).toFixed(2)} ${frete.labelIsencao||""}`, 10, y); y+=8;

      // Total
      doc.setFontSize(14);
      doc.text(`TOTAL: R$ ${totalPedido.toFixed(2)}`, 10, y);

      if(obs){ y+=10; doc.setFontSize(10); doc.text(`Obs: ${obs}`, 10, y); }

      const nomeArq = `Pedido_${cliente.replace(/\s+/g,'_')}.pdf`;
      if(apenasSalvar) doc.save(nomeArq); else window.open(doc.output("bloburl"), "_blank");
    }
    window.gerarPDF = gerarPDF;
    window.compartilharPDF = async ()=>{ await gerarPDF(false); };

    document.addEventListener("DOMContentLoaded", ()=>{
      renderItens();
      document.getElementById("endereco").addEventListener("blur", atualizarFreteUI);
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    });
  </script>
</body>
</html>
