<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- favicons (caminhos relativos p/ GitHub Pages) -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <link rel="manifest" href="manifest.json" />
  <title>PEDIDOS V3.0</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
    h1 { text-align: right; margin-bottom: 10px; font-size: 30px; }
    .logo-header { width: 360px; display: block; margin: 0 auto 10px auto; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .item { border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 10px; }
    .total { font-weight: bold; font-size: 1.2em; }
    button { width: 100%; padding: 10px; background: #008000; color: white; border: none; font-size: 1em; margin-top: 5px; border-radius: 6px; cursor:pointer; }
    .remove { background: #c0392b; }
    .pdf-btn { background: #005580; margin-top: 10px; }
    .pdf-btn.salvar { background: #3d7311; }
    .pdf-btn.compartilhar { background: #b06912; }
    .tipo-select { width: auto; margin-right: 10px; }
    label { font-weight: bold; }
    .field-group { margin-bottom: 12px; }
    .switch-box { display: flex; gap: 20px; justify-content: left; align-items: center; margin-bottom: 12px; }
    #pagamentoOutro { margin-top: 6px; }
    .top-actions { display:flex; gap:8px; margin:6px 0 10px; }
    .top-actions a { background:#0ea5a6; color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:600; }
    .muted{ color:#666; font-size:0.9em }
    #freteValor { font-weight: bold; }
    @media (max-width: 450px) {
      h1 { font-size: 1.1em; }
      .logo-header { width: 110px; }
      .item { padding: 6px; }
      button, .pdf-btn { padding: 7px; font-size: 0.96em; }
      input, select, textarea { padding: 6px; }
      .field-group { margin-bottom: 8px; }
      .top-actions a { padding:6px 8px; font-size:0.9em; }
    }
  </style>
</head>
<body>
  <img src="Serra-Nobre_3.png" alt="Logo" class="logo-header" onerror="this.style.display='none'">
  <h1>PEDIDOS V3.0</h1>

  <div class="top-actions">
    <a href="relatorios.html" title="Abrir Relatórios">Relatórios</a>
  </div>

  <div class="field-group">
    <label>Cliente:</label>
    <input list="listaClientes" type="text" id="cliente" autocomplete="off" required
           onfocus="popularClientesMaisUsados()"
           onblur="preencherEnderecoCliente(); carregarSugestoesProdutosDoCliente();" />
    <datalist id="listaClientes"></datalist>
  </div>

  <div class="field-group">
    <label>Endereço:</label>
    <input type="text" id="endereco" autocomplete="off" required onblur="atualizarFreteUI()"/>
  </div>

  <div class="field-group">
    <label>Data de Entrega:</label>
    <input type="date" id="entrega" required/>
  </div>

  <div class="field-group">
    <label>Horário de Entrega:</label>
    <input type="time" id="horaEntrega" required/>
  </div>

  <div class="field-group switch-box">
    <label>Entrega/Retirada:</label>
    <label><input type="radio" name="tipoEntrega" value="ENTREGA" checked> Entrega</label>
    <label><input type="radio" name="tipoEntrega" value="RETIRADA"> Retirada</label>
  </div>

  <div class="field-group">
    <label>Valor do Frete:</label>
    <div id="freteValor" class="muted">—</div>
  </div>

  <div id="itens"></div>
  <button onclick="adicionarItem()">Adicionar Item</button>

  <hr/>
  <label>Forma de Pagamento:</label>
  <select id="pagamento">
    <option value="PIX">PIX</option>
    <option value="DINHEIRO">DINHEIRO</option>
    <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
    <option value="OUTRO">OUTRO</option>
  </select>
  <input type="text" id="pagamentoOutro" placeholder="Digite outra forma de pagamento" style="display:none"/>

  <hr/>
  <label>Observação geral do pedido:</label>
  <textarea id="obsGeral"></textarea>
  <hr/>

  <button class="pdf-btn" onclick="gerarPDF(false)">Gerar PDF</button>
  <button class="pdf-btn salvar" onclick="gerarPDF(true)">Salvar PDF</button>
  <button class="pdf-btn compartilhar" onclick="compartilharPDF()">Compartilhar PDF</button>

  <div id="resumo"></div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase (mantido igual) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, updateDoc, increment, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app-check.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3zBW_WhVfNpX5uoJCq-6WysE5XKYKZt4",
      authDomain: "serranobrepedidos.firebaseapp.com",
      projectId: "serranobrepedidos",
      storageBucket: "serranobrepedidos.firebasestorage.app",
      messagingSenderId: "948939268023",
      appId: "1:948939268023:web:3f1f6c18f2c047c82b1232"
    };

    const app = initializeApp(firebaseConfig);

    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider("6Lf0MK0rAAAAACI68fwbg7RDERSlL0AW5zKd-sDA"),
      isTokenAutoRefreshEnabled: true
    });

    const auth = getAuth(app);
    const authReady = new Promise((resolve) => {
      onAuthStateChanged(auth, (user) => {
        if (user) resolve(user);
        else signInAnonymously(auth).catch((e) => console.error("Falha ao entrar anonimamente:", e));
      });
    });

    const db = getFirestore(app);
    window.firebaseReady = authReady;

    async function salvarCliente(nome, endereco) {
      await authReady;
      const nomeNorm = (nome || "").trim();
      const enderecoNorm = (endereco || "").trim();
      if (!nomeNorm) return;

      const qCli = query(collection(db, "clientes"), where("nome", "==", nomeNorm), limit(1));
      const snap = await getDocs(qCli);

      if (!snap.empty) {
        const ref = snap.docs[0].ref;
        const atual = snap.docs[0].data();
        const campos = { atualizadoEm: new Date() };
        if ((atual.endereco || "") !== enderecoNorm) campos.endereco = enderecoNorm;
        await updateDoc(ref, campos);
      } else {
        await addDoc(collection(db, "clientes"), { nome: nomeNorm, endereco: enderecoNorm, compras: 0, criadoEm: new Date() });
      }
    }

    async function buscarEnderecoCliente(nomeCliente) {
      await authReady;
      const nome = (nomeCliente || "").trim();
      if (!nome) return "";
      const q = query(collection(db, "clientes"), where("nome", "==", nome), limit(1));
      const s = await getDocs(q);
      return s.empty ? "" : (s.docs[0].data().endereco || "");
    }

    async function clientesMaisUsados(limitQtd = 50) {
      await authReady;
      const lista = [];
      const qs = await getDocs(collection(db, "clientes"));
      qs.forEach(d => {
        const x = d.data();
        if ((x?.nome || "").trim()) lista.push({ nome: x.nome.trim(), compras: x.compras || 0 });
      });
      lista.sort((a,b)=> b.compras - a.compras || a.nome.localeCompare(b.nome));
      return lista.slice(0, limitQtd).map(x => x.nome);
    }

    async function buscarUltimoPreco(clienteNome, produtoNome) {
      await authReady;
      const nomeCli  = (clienteNome || "").trim();
      const nomeProd = (produtoNome || "").trim();
      if (!nomeCli || !nomeProd) return null;

      const q = query(collection(db, "historico_precos"), where("cliente", "==", nomeCli), where("produto", "==", nomeProd), orderBy("data", "desc"), limit(1));
      const qs = await getDocs(q);
      if (qs.empty) return null;
      const dados = qs.docs[0].data();
      return typeof dados.preco === "number" ? dados.preco : parseFloat(dados.preco);
    }

    async function produtosDoCliente(nomeCliente) {
      await authReady;
      const nome = (nomeCliente || "").trim();
      if (!nome) return [];
      const set = new Set();
      const q = query(collection(db, "historico_precos"), where("cliente", "==", nome), orderBy("data", "desc"), limit(1000));
      const qs = await getDocs(q);
      qs.forEach(d => { const p = (d.data().produto || "").trim(); if (p) set.add(p); });
      return [...set].sort((a,b)=>a.localeCompare(b));
    }

    async function registrarPrecoCliente(clienteNome, produtoNome, preco) {
      await authReady;
      const nomeCli  = (clienteNome || "").trim();
      const nomeProd = (produtoNome || "").trim();
      const valor    = parseFloat(preco);
      if (!nomeCli || !nomeProd || isNaN(valor)) return;

      await addDoc(collection(db, "historico_precos"), { cliente: nomeCli, produto: nomeProd, preco: valor, data: new Date() });

      const qCli = query(collection(db, "clientes"), where("nome", "==", nomeCli), limit(1));
      const s = await getDocs(qCli);
      if (!s.empty) {
        await updateDoc(s.docs[0].ref, { compras: increment(1), atualizadoEm: new Date() });
      }
    }

    async function carregarSugestoesProdutosDoCliente() {
      await authReady;
      const nome = document.getElementById("cliente").value.trim();
      const listaProdutos = document.getElementById("listaProdutos");
      if (!listaProdutos) return;
      const nomes = await produtosDoCliente(nome);
      listaProdutos.innerHTML = nomes.map(p => `<option value="${p}"></option>`).join("");
    }

    async function popularClientesMaisUsados() {
      await authReady;
      const lista = await clientesMaisUsados();
      document.getElementById("listaClientes").innerHTML = lista.map(n => `<option value="${n}"></option>`).join("");
    }

    async function savePedido(payload){
      await authReady;
      const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      await setDoc(doc(collection(db, "pedidos"), id), { ...payload, createdAt: serverTimestamp() });
      return id;
    }

    window.salvarCliente = salvarCliente;
    window.buscarEnderecoCliente = buscarEnderecoCliente;
    window.buscarUltimoPreco = buscarUltimoPreco;
    window.registrarPrecoCliente = registrarPrecoCliente;
    window.carregarSugestoesProdutosDoCliente = carregarSugestoesProdutosDoCliente;
    window.popularClientesMaisUsados = popularClientesMaisUsados;
    window.savePedido = savePedido;
  </script>

  <!-- Scripts adicionais como antes (PDF, frete, etc.) estariam aqui -->

  <datalist id="listaProdutos"></datalist>
</body>
</html>
